<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartFace - Enhanced Facial Recognition Attendance System</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --warning: #f8961e;
            --info: #7209b7;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --white: #ffffff;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
            
            /* Dark mode variables */
            --bg-color: #eef3fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --table-header-bg: var(--primary);
            --table-row-even: #f8f9fa;
            --table-row-hover: #e9ecef;
        }

        .dark-mode {
            --bg-color: #121212;
            --text-color: #f8f9fa;
            --card-bg: #1e1e1e;
            --table-header-bg: #2d2d2d;
            --table-row-even: #2a2a2a;
            --table-row-hover: #3a3a3a;
            --light: #2a2a2a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .login-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: fadeInUp 0.8s ease;
        }

        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-header h1 {
            color: var(--primary);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        .login-form .form-group {
            margin-bottom: 20px;
        }

        .login-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .login-form input {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 2px solid var(--gray);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        .login-form input:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .login-btn:hover {
            background-color: var(--primary-dark);
        }

        .hidden {
            display: none !important;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
            position: relative;
        }

        h1 {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 10px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }

        h2 {
            font-size: 1.8rem;
            color: var(--secondary);
            margin-bottom: 20px;
            font-weight: 600;
        }

        h3 {
            font-size: 1.4rem;
            color: var(--text-color);
            margin-bottom: 15px;
            font-weight: 500;
        }

        /* Navigation Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            animation: fadeIn 0.8s ease;
            background: var(--card-bg);
            padding: 10px;
            border-radius: 12px;
            box-shadow: var(--card-shadow);
        }

        .tab {
            padding: 12px 24px;
            background-color: var(--card-bg);
            border-radius: 50px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            box-shadow: var(--card-shadow);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tab:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .tab.active {
            background-color: var(--primary);
            color: var(--white);
            border-color: var(--primary-dark);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .tab-content.active {
            display: block;
        }

        /* Cards */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        input[type="password"],
        select {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 2px solid var(--gray);
            border-radius: 8px;
            font-size: 16px;
            transition: var(--transition);
        }

        input:focus,
        select:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 24px;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            text-align: center;
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .btn-secondary {
            background-color: var(--gray);
        }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-success:hover {
            background-color: #3ab7db;
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-danger:hover {
            background-color: #e5177e;
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-warning:hover {
            background-color: #e68a1a;
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-info:hover {
            background-color: #5a08a0;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* Video Elements */
        .video-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        video, canvas {
            width: 100%;
            height: auto;
            border-radius: 12px;
            display: block;
        }

        .capture-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        /* Status Messages */
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
            animation: fadeIn 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .success-message {
            background-color: rgba(76, 201, 240, 0.2);
            color: #0a9396;
            border-left: 4px solid var(--success);
        }

        .error-message {
            background-color: rgba(247, 37, 133, 0.2);
            color: var(--danger);
            border-left: 4px solid var(--danger);
        }

        .info-message {
            background-color: rgba(248, 150, 30, 0.2);
            color: var(--warning);
            border-left: 4px solid var(--warning);
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            animation: fadeInUp 0.8s ease;
        }

        th, td {
            padding: 12px 8px;
            text-align: left;
            border-bottom: 1px solid var(--gray);
            color: var(--text-color);
        }

        th {
            background-color: var(--table-header-bg);
            color: var(--white);
            font-weight: 500;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        tr:hover {
            background-color: var(--table-row-hover);
        }

        .attendance-status {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
        }

        .present {
            background-color: var(--success);
        }

        .absent {
            background-color: var(--danger);
        }

        .late {
            background-color: var(--warning);
        }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        /* Timer */
        .attendance-timer {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            animation: fadeIn 0.5s ease;
        }

        .timer-display {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        /* Settings */
        .settings-panel {
            background-color: var(--light);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: fadeIn 0.5s ease;
        }

        .settings-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
        }

        .settings-row label {
            margin-bottom: 0;
            min-width: 200px;
        }

        .face-overlay-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .face-overlay {
            position: absolute;
            border: 2px solid var(--success);
            border-radius: 5px;
            background-color: rgba(76, 201, 240, 0.2);
        }

        .face-label {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 10px;
            transform: translateY(-100%);
        }

        .liveness-indicator {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .liveness-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--danger);
        }

        .liveness-dot.active {
            background-color: var(--success);
        }

        .verification-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            background-color: var(--light);
        }

        .verification-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .verification-step i {
            font-size: 16px;
        }

        .step-complete {
            color: var(--success);
        }

        .step-pending {
            color: var(--gray);
        }

        .step-active {
            color: var(--primary);
            font-weight: 500;
        }

        .challenge-prompt {
            background-color: var(--info);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            font-weight: 500;
            animation: pulse 2s infinite;
        }

        .security-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background-color: var(--light);
            border-radius: 8px;
            margin: 10px 0;
        }

        .security-score {
            font-weight: 600;
            font-size: 1.1rem;
        }

        .score-high { color: var(--success); }
        .score-medium { color: var(--warning); }
        .score-low { color: var(--danger); }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .blink {
            animation: blink 1s infinite;
        }

        /* Export button */
        .export-btn-container {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
        }

        /* Responsive styles */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 2rem;
            }

            h2 {
                font-size: 1.5rem;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                width: 100%;
                text-align: center;
                justify-content: center;
            }

            .settings-row {
                flex-direction: column;
                align-items: flex-start;
            }

            .settings-row label {
                min-width: auto;
            }

            .action-btns {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                margin-bottom: 10px;
            }

            /* Mobile table styles */
            table {
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }

            th, td {
                min-width: 120px;
                padding: 8px 5px;
                font-size: 14px;
            }

            .attendance-status {
                flex-direction: column;
                align-items: flex-start;
                gap: 2px;
            }

            .status-dot {
                margin-right: 5px;
            }
        }

        @media (max-width: 480px) {
            th, td {
                min-width: 100px;
                padding: 6px 3px;
                font-size: 12px;
            }

            .card {
                padding: 15px;
            }

            .video-container {
                margin-bottom: 15px;
            }

            .capture-controls {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }
        }

        /* Loading spinner */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-radius: 50%;
            border-top: 4px solid var(--primary);
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Stats cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .stat-card i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card .label {
            color: var(--gray);
            font-size: 0.9rem;
        }
        
        /* Chart containers */
        .chart-container {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 50px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            position: relative;
            height: 300px;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 1.0rem;
            margin-bottom: 5px;
            margin-top: -12px;
            color: var(--text-color);
            font-weight: 600;
        }

        /* Analytics Grid */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Student Recommendations */
        .recommendation-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
            border-left: 4px solid var(--primary);
        }

        .recommendation-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .recommendation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .recommendation-title {
            font-weight: 600;
            color: var(--text-color);
        }

        .recommendation-priority {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .priority-high {
            background-color: rgba(247, 37, 133, 0.2);
            color: var(--danger);
        }

        .priority-medium {
            background-color: rgba(248, 150, 30, 0.2);
            color: var(--warning);
        }

        .priority-low {
            background-color: rgba(76, 201, 240, 0.2);
            color: var(--success);
        }

        .recommendation-content {
            color: var(--text-color);
            margin-bottom: 10px;
        }

        /* Session Management */
        .session-card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--card-shadow);
            transition: var(--transition);
        }

        .session-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .session-title {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .session-meta {
            display: flex;
            gap: 15px;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .session-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .session-stat {
            text-align: center;
            padding: 10px;
            background-color: var(--light);
            border-radius: 8px;
        }

        .session-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary);
        }

        .session-stat-label {
            font-size: 0.8rem;
            color: var(--gray);
        }

        /* Dark Mode Toggle in Settings */
        .dark-mode-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg);
            padding: 8px 15px;
            border-radius: 30px;
            box-shadow: var(--card-shadow);
            width: fit-content;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--primary);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Camera Controls */
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .bubbles {
            position: fixed;
            z-index: -5;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .bubble {
            position: absolute;
            bottom: -75%;
            display: block;
            border-radius: 50%;
            animation: float-up ease-in infinite;
        }

        .bubble::before {
            position: absolute;
            content: '';
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: hsla(0, 0%, 100%, 0.7);
            border-radius: inherit;
            animation: ease-in-out alternate infinite;
        }

        @keyframes float-up {
            to {
                transform: translateY(-175vh);
            }
        }

        @keyframes sway-left-to-right {
            from {
                transform: translateX(-100%);
            }
            to {
                transform: translateX(100%);
            }
        }

        @keyframes sway-right-to-left {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body>

    <div class="bubbles">
        <!-- Bubbles will be generated by JavaScript -->
    </div>

    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <div class="login-header">
                <h1><i class="fas fa-user-check"></i> SmartFace</h1>
                <p>Enhanced Facial Recognition Attendance System</p>
            </div>
            <form class="login-form" id="login-form">
                <div class="form-group">
                    <label for="username"><i class="fas fa-user"></i> Username</label>
                    <input type="text" id="username" placeholder="Enter your username" required>
                </div>
                <div class="form-group">
                    <label for="password"><i class="fas fa-lock"></i> Password</label>
                    <input type="password" id="password" placeholder="Enter your password" required>
                </div>
                <button type="submit" class="login-btn"><i class="fas fa-sign-in-alt"></i> Login</button>
            </form>
            <div id="login-message" class="status-message hidden"></div>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="hidden">
        <div class="container">
            <header>
                <h1><i class="fas fa-user-check"></i> SmartFace Attendance</h1>
                <p>Enhanced attendance tracking with AI analytics and recommendations</p>
                <button id="logout-btn" class="btn btn-danger" style="position: absolute; top: 0; right: 0;">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </header>
            
            <!-- Stats Overview -->
            <div class="stats-container">
                <div class="stat-card">
                    <i class="fas fa-users"></i>
                    <div class="value" id="total-students">0</div>
                    <div class="label">Total Students</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-calendar-day"></i>
                    <div class="value" id="today-attendance">0%</div>
                    <div class="label">Today's Attendance</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-user-clock"></i>
                    <div class="value" id="late-arrivals">0</div>
                    <div class="label">Late Arrivals</div>
                </div>
                <div class="stat-card">
                    <i class="fas fa-chart-line"></i>
                    <div class="value" id="monthly-average">0%</div>
                    <div class="label">Monthly Average</div>
                </div>
            </div>
            
            <div class="tabs">
                <div class="tab active" onclick="openTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</div>
                <div class="tab" onclick="openTab('register')"><i class="fas fa-user-plus"></i> Register Student</div>
                <div class="tab" onclick="openTab('attendance')"><i class="fas fa-calendar-check"></i> Take Attendance</div>
                <div class="tab" onclick="openTab('sessions')"><i class="fas fa-clock"></i> All Sessions</div>
                <div class="tab" onclick="openTab('manage')"><i class="fas fa-user-graduate"></i> Manage Students</div>
                <div class="tab" onclick="openTab('report')"><i class="fas fa-chart-bar"></i> Analytics & Reports</div>
                <div class="tab" onclick="openTab('settings')"><i class="fas fa-cog"></i> Settings</div>
            </div>
            
            <!-- Dashboard Tab -->
            <div id="dashboard" class="tab-content active">
                <div class="card">
                    <h2><i class="fas fa-tachometer-alt"></i> Analytics Dashboard</h2>
                    
                    <div class="analytics-grid">
                        <div class="chart-container">
                            <div class="chart-title">Attendance Trend (Last 7 Days)</div>
                            <canvas id="attendance-trend-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">Attendance Distribution</div>
                            <canvas id="attendance-distribution-chart"></canvas>
                        </div>
                    </div>
                    
                    <div class="analytics-grid">
                        <div class="chart-container">
                            <div class="chart-title">Student Performance</div>
                            <canvas id="student-performance-chart"></canvas>
                        </div>
                        
                        <div class="chart-container">
                            <div class="chart-title">Attendance by Day of Week</div>
                            <canvas id="day-of-week-chart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h2><i class="fas fa-lightbulb"></i> Student Recommendations</h2>
                    <div id="recommendations-container">
                        <!-- Recommendations will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Register Student Tab -->
            <div id="register" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <h2><i class="fas fa-user-plus"></i> Register New Student</h2>
                        <div class="spinner hidden" id="model-loading"></div>
                    </div>
                    
                    <div class="camera-controls">
                        <button id="switch-camera" class="btn btn-secondary">
                            <i class="fas fa-camera"></i> Switch Camera
                        </button>
                    </div>
                    
                    <div class="video-container">
                        <video id="video" autoplay muted playsinline></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div id="face-overlays" class="face-overlay-container"></div>
                        <div id="liveness-indicator" class="liveness-indicator hidden">
                            <div class="liveness-dot"></div>
                            <span>Verifying liveness...</span>
                        </div>
                    </div>
                    
                    <div class="capture-controls">
                        <button id="capture-btn" class="btn btn-success"><i class="fas fa-camera"></i> Capture Face</button>
                        <button id="retake-btn" class="btn btn-secondary hidden"><i class="fas fa-redo"></i> Retake</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="name"><i class="fas fa-signature"></i> Full Name</label>
                        <input type="text" id="name" placeholder="Enter student's full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="reg-number"><i class="fas fa-id-card"></i> Registration Number</label>
                        <input type="text" id="reg-number" placeholder="Enter unique registration number">
                    </div>
                    
                    <button id="save-btn" class="btn"><i class="fas fa-save"></i> Save Student</button>
                    
                    <div id="register-message" class="status-message hidden"></div>
                </div>
            </div>
            
            <!-- Take Attendance Tab -->
            <div id="attendance" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-calendar-check"></i> Take Attendance</h2>
                    
                    <div class="settings-panel">
                        <h3><i class="fas fa-cog"></i> Attendance Session</h3>
                        <div class="settings-row">
                            <label for="attendance-date"><i class="fas fa-calendar"></i> Date:</label>
                            <input type="date" id="attendance-date">
                        </div>
                        <div class="settings-row">
                            <label for="session-name"><i class="fas fa-clock"></i> Session Name:</label>
                            <input type="text" id="session-name" placeholder="e.g., Morning Lecture">
                        </div>
                        <div class="settings-row">
                            <label for="time-limit"><i class="fas fa-hourglass-half"></i> Time Limit (minutes):</label>
                            <input type="number" id="time-limit" min="1" value="15">
                        </div>
                        <div class="settings-row">
                            <label for="recognition-threshold"><i class="fas fa-sliders-h"></i> Recognition Threshold:</label>
                            <input type="range" id="recognition-threshold" min="0.1" max="1.0" step="0.05" value="0.5">
                            <span id="threshold-value">0.5</span>
                        </div>
                    </div>
                    
                    <div class="camera-controls">
                        <button id="attendance-switch-camera" class="btn btn-secondary">
                            <i class="fas fa-camera"></i> Switch Camera
                        </button>
                    </div>
                    
                    <div class="attendance-timer hidden" id="timer-panel">
                        <div>
                            <div>Time Remaining:</div>
                            <div class="timer-display" id="timer-display">15:00</div>
                        </div>
                        <button id="extend-time" class="btn btn-warning"><i class="fas fa-plus-circle"></i> +5 Min</button>
                    </div>

                    <!-- Security Level Indicator -->
                    <div class="security-indicator">
                        <i class="fas fa-shield-alt"></i>
                        <span>Anti-Spoofing Security:</span>
                        <span class="security-score score-high" id="security-score">High</span>
                    </div>

                    <!-- Liveness Verification Status -->
                    <div id="liveness-verification" class="verification-status hidden">
                        <div class="verification-step" id="step-face-detected">
                            <i class="fas fa-user"></i>
                            <span>Face Detected</span>
                        </div>
                        <div class="verification-step" id="step-movement-check">
                            <i class="fas fa-arrows-alt"></i>
                            <span>Movement Check</span>
                        </div>
                        <div class="verification-step" id="step-blink-detection">
                            <i class="fas fa-eye"></i>
                            <span>Blink Detection</span>
                        </div>
                        <div class="verification-step" id="step-challenge-response">
                            <i class="fas fa-random"></i>
                            <span>Challenge</span>
                        </div>
                        <div class="verification-step" id="step-attendance-marked">
                            <i class="fas fa-check-circle"></i>
                            <span>Attendance Marked</span>
                        </div>
                    </div>

                    <!-- Challenge Prompt -->
                    <div id="challenge-prompt" class="challenge-prompt hidden">
                        <i class="fas fa-bullhorn"></i>
                        <span id="challenge-text">Please follow the instruction...</span>
                    </div>
                    
                    <div class="video-container">
                        <video id="attendance-video" autoplay muted playsinline></video>
                        <canvas id="attendance-canvas" class="hidden"></canvas>
                        <div id="attendance-overlays" class="face-overlay-container"></div>
                        <div id="attendance-liveness" class="liveness-indicator">
                            <div class="liveness-dot"></div>
                            <span>Anti-spoofing active</span>
                        </div>
                    </div>
                    
                    <div class="capture-controls">
                        <button id="start-attendance" class="btn btn-success"><i class="fas fa-play-circle"></i> Start Attendance</button>
                        <button id="stop-attendance" class="btn btn-danger hidden"><i class="fas fa-stop-circle"></i> Stop Session</button>
                    </div>
                    
                    <div id="attendance-message" class="status-message hidden"></div>
                    
                    <h3><i class="fas fa-list"></i> Current Session Attendance</h3>
                    <div class="table-responsive">
                        <table id="current-attendance">
                            <thead>
                                <tr>
                                    <th>Reg No.</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- All Sessions Tab -->
            <div id="sessions" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-clock"></i> All Attendance Sessions</h2>
                    <div class="form-group">
                        <label for="session-filter"><i class="fas fa-filter"></i> Filter by Date</label>
                        <input type="date" id="session-filter">
                    </div>
                    <div id="sessions-container">
                        <!-- Sessions will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Manage Students Tab -->
            <div id="manage" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-user-graduate"></i> Manage Students</h2>
                    <div class="table-responsive">
                        <table id="students-table">
                            <thead>
                                <tr>
                                    <th>Reg No.</th>
                                    <th>Name</th>
                                    <th>Attendance Rate</th>
                                    <th>Punctuality</th>
                                    <th>Last Attendance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Analytics & Reports Tab -->
            <div id="report" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-chart-bar"></i> Advanced Analytics & Reports</h2>
                    
                    <div class="form-group">
                        <label for="report-date-range"><i class="fas fa-calendar"></i> Date Range</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" id="report-start-date">
                            <span>to</span>
                            <input type="date" id="report-end-date">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="report-session"><i class="fas fa-clock"></i> Select Session (optional)</label>
                        <select id="report-session">
                            <option value="">All Sessions</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <button id="generate-report" class="btn"><i class="fas fa-sync"></i> Generate Report</button>
                        <button id="export-report" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export as CSV</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table id="report-table">
                            <thead>
                                <tr>
                                    <th>Reg No.</th>
                                    <th>Name</th>
                                    <th>Status</th>
                                    <th>Time</th>
                                    <th>Session</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Settings Tab -->
            <div id="settings" class="tab-content">
                <div class="card">
                    <h2><i class="fas fa-cog"></i> System Settings</h2>
                    
                    <div class="settings-panel">
                        <h3><i class="fas fa-palette"></i> Appearance</h3>
                        <div class="dark-mode-toggle">
                            <i class="fas fa-moon"></i>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dark-mode-toggle">
                                <span class="slider"></span>
                            </label>
                            <i class="fas fa-sun"></i>
                            <span>Dark Mode</span>
                        </div>
                    </div>
                    
                    <div class="settings-panel">
                        <h3><i class="fas fa-clock"></i> Attendance Settings</h3>
                        <div class="settings-row">
                            <label for="default-time-limit">Default Time Limit (minutes):</label>
                            <input type="number" id="default-time-limit" min="1" value="15">
                        </div>
                        <div class="settings-row">
                            <label for="late-threshold">Late Threshold (minutes):</label>
                            <input type="number" id="late-threshold" min="0" value="5">
                        </div>
                        <div class="settings-row">
                            <label for="default-recognition-threshold">Default Recognition Threshold:</label>
                            <input type="range" id="default-recognition-threshold" min="0.1" max="1.0" step="0.05" value="0.5">
                            <span id="default-threshold-value">0.5</span>
                        </div>
                    </div>
                    
                    <div class="settings-panel">
                        <h3><i class="fas fa-shield-alt"></i> Security Settings</h3>
                        <div class="settings-row">
                            <label for="require-liveness">Require Anti-Spoofing:</label>
                            <input type="checkbox" id="require-liveness" checked>
                        </div>
                        <div class="settings-row">
                            <label for="security-level">Security Level:</label>
                            <select id="security-level">
                                <option value="low">Low (Basic)</option>
                                <option value="medium" selected>Medium (Balanced)</option>
                                <option value="high">High (Maximum)</option>
                            </select>
                        </div>
                        <div class="settings-row">
                            <label for="enable-challenge">Enable Challenge-Response:</label>
                            <input type="checkbox" id="enable-challenge" checked>
                        </div>
                        <div class="settings-row">
                            <label for="enable-blink-detection">Enable Blink Detection:</label>
                            <input type="checkbox" id="enable-blink-detection" checked>
                        </div>
                    </div>
                    
                    <div class="settings-panel">
                        <h3><i class="fas fa-database"></i> Data Management</h3>
                        <button id="export-data" class="btn btn-secondary"><i class="fas fa-file-export"></i> Export All Data</button>
                        <button id="import-data" class="btn btn-secondary"><i class="fas fa-file-import"></i> Import Data</button>
                        <button id="clear-data" class="btn btn-danger"><i class="fas fa-trash"></i> Clear All Data</button>
                    </div>
                    
                    <div id="settings-message" class="status-message hidden"></div>
                </div>
            </div>
        </div>
    </div>

<script>
    // Global variables
    let video = document.getElementById('video');
    let canvas = document.getElementById('canvas');
    let ctx = canvas.getContext('2d');
    let attendanceVideo = document.getElementById('attendance-video');
    let attendanceCanvas = document.getElementById('attendance-canvas');
    let attendanceCtx = attendanceCanvas.getContext('2d');
    let modelsLoaded = false;
    let isCapturing = false;
    let currentSession = null;
    let attendanceTimer = null;
    let timeRemaining = 0;
    let attendanceInterval = null;
    let currentUser = null;
    let livenessCheckInProgress = false;
    let livenessVerificationHistory = [];
    let blinkDetectionHistory = [];
    let currentChallenge = null;
    let challengeStartTime = null;
    let charts = {
        attendanceTrend: null,
        attendanceDistribution: null,
        studentPerformance: null,
        dayOfWeek: null
    };
    let currentCamera = 'user'; // 'user' for front camera, 'environment' for rear

    // Data storage (fallback to localStorage)
    let students = JSON.parse(localStorage.getItem('students')) || [];
    let attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords')) || [];
    let attendanceSessions = JSON.parse(localStorage.getItem('attendanceSessions')) || [];
    let settings = JSON.parse(localStorage.getItem('settings')) || {
        defaultTimeLimit: 15,
        lateThreshold: 5,
        recognitionThreshold: 0.5,
        requireLiveness: true,
        securityLevel: 'medium',
        enableChallenge: true,
        enableBlinkDetection: true
    };

    // Challenge types for anti-spoofing
    const CHALLENGES = [
        { type: 'head_turn', instruction: 'Slowly turn your head LEFT', direction: 'left' },
        { type: 'head_turn', instruction: 'Slowly turn your head RIGHT', direction: 'right' },
        { type: 'head_turn', instruction: 'Slowly turn your head UP', direction: 'up' },
        { type: 'head_turn', instruction: 'Slowly turn your head DOWN', direction: 'down' },
        { type: 'blink', instruction: 'Blink your eyes 2 times quickly', count: 2 },
        { type: 'smile', instruction: 'Smile for the camera', expression: 'happy' }
    ];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', async function() {
        // Check if user is already logged in
        const savedUser = localStorage.getItem('currentUser');
        if (savedUser) {
            currentUser = JSON.parse(savedUser);
            showMainApp();
        } else {
            showLoginPage();
        }

        // Set up event listeners
        setupEventListeners();
        
        // Set today's date as default for attendance and reports
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('attendance-date').value = today;
        
        // Set default date range for reports (last 7 days)
        const sevenDaysAgo = new Date();
        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
        document.getElementById('report-start-date').value = sevenDaysAgo.toISOString().split('T')[0];
        document.getElementById('report-end-date').value = today;
        
        // Load settings
        loadSettings();
        
        // Load models if user is logged in
        if (currentUser) {
            await loadModels();
        }
        
        // Initialize bubbles
        initializeBubbles();
        
        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.getElementById('dark-mode-toggle').checked = true;
            document.body.classList.add('dark-mode');
        }
    });

    // Initialize background bubbles
    function initializeBubbles() {
        const container = document.querySelector('.bubbles');
        const bubbleCount = 50;
        const swayTypes = ['sway-left-to-right', 'sway-right-to-left'];

        function random(min, max) {
            return Math.random() * (max - min) + min;
        }

        for (let i = 0; i < bubbleCount; i++) {
            const bubble = document.createElement('div');
            bubble.classList.add('bubble');

            // Randomized properties
            const left = random(0, 100);
            const radius = random(1, 10);
            const floatDuration = random(6, 12);
            const swayDuration = random(4, 6);
            const floatDelay = random(0, 4);
            const swayDelay = random(0, 4);
            const swayType = swayTypes[Math.floor(Math.random() * swayTypes.length)];

            // Apply styles
            bubble.style.left = `${left}vw`;
            bubble.style.width = `${radius}vw`;
            bubble.style.height = `${radius}vw`;
            bubble.style.animationDuration = `${floatDuration}s`;
            bubble.style.animationDelay = `${floatDelay}s`;

            // Pseudo-element via CSS variable (for sway animation)
            bubble.style.setProperty('--sway-type', swayType);
            bubble.style.setProperty('--sway-duration', `${swayDuration}s`);
            bubble.style.setProperty('--sway-delay', `${swayDelay}s`);

            // Add a unique style for the ::before animation using CSS variables
            bubble.innerHTML = `<style>
                .bubble:nth-child(${i + 1})::before {
                animation-name: ${swayType};
                animation-duration: ${swayDuration}s;
                animation-delay: ${swayDelay}s;
                }
            </style>`;

            container.appendChild(bubble);
        }
    }

    // Show login page
    function showLoginPage() {
        document.getElementById('login-page').classList.remove('hidden');
        document.getElementById('main-app').classList.add('hidden');
    }

    // Show main application
    function showMainApp() {
        document.getElementById('login-page').classList.add('hidden');
        document.getElementById('main-app').classList.remove('hidden');
        updateStats();
        loadStudentsTable();
        loadAllSessions();
        generateRecommendations();
        // Don't initialize charts here - wait for dashboard tab to be opened
    }

    // Setup event listeners
    function setupEventListeners() {
        // Login form
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        
        // Logout button
        document.getElementById('logout-btn').addEventListener('click', handleLogout);
        
        // Dark mode toggle
        document.getElementById('dark-mode-toggle').addEventListener('change', toggleDarkMode);
        
        // Register student tab
        document.getElementById('capture-btn').addEventListener('click', captureFace);
        document.getElementById('retake-btn').addEventListener('click', retakeFace);
        document.getElementById('save-btn').addEventListener('click', saveStudent);
        document.getElementById('switch-camera').addEventListener('click', switchCamera);
        
        // Attendance tab
        document.getElementById('start-attendance').addEventListener('click', startAttendance);
        document.getElementById('stop-attendance').addEventListener('click', stopAttendance);
        document.getElementById('extend-time').addEventListener('click', extendTime);
        document.getElementById('recognition-threshold').addEventListener('input', updateThresholdValue);
        document.getElementById('attendance-switch-camera').addEventListener('click', switchAttendanceCamera);
        
        // Sessions tab
        document.getElementById('session-filter').addEventListener('change', loadAllSessions);
        
        // Reports tab
        document.getElementById('generate-report').addEventListener('click', generateReport);
        document.getElementById('export-report').addEventListener('click', exportReport);
        
        // Settings tab
        document.getElementById('default-recognition-threshold').addEventListener('input', updateDefaultThresholdValue);
        document.getElementById('security-level').addEventListener('change', saveSettings);
        document.getElementById('enable-challenge').addEventListener('change', saveSettings);
        document.getElementById('enable-blink-detection').addEventListener('change', saveSettings);
        document.getElementById('export-data').addEventListener('click', exportAllData);
        document.getElementById('clear-data').addEventListener('click', clearAllData);
    }

    // Login handler
    async function handleLogin(e) {
        e.preventDefault();
        
        const username = document.getElementById('username').value;
        const password = document.getElementById('password').value;
        const messageEl = document.getElementById('login-message');
        
        // Simple authentication
        if (username === 'admin' && password === 'admin') {
            currentUser = { username, role: 'admin' };
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            messageEl.textContent = 'Login successful! Loading system...';
            messageEl.className = 'status-message success-message';
            messageEl.classList.remove('hidden');
            
            // Load models and show main app
            await loadModels();
            setTimeout(() => {
                showMainApp();
            }, 1000);
        } else {
            messageEl.textContent = 'Invalid username or password. Try admin/admin for demo.';
            messageEl.className = 'status-message error-message';
            messageEl.classList.remove('hidden');
        }
    }

    // Logout handler
    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('currentUser');
        showLoginPage();
    }

    // Load face-api.js models
    async function loadModels() {
        const modelLoading = document.getElementById('model-loading');
        modelLoading.classList.remove('hidden');
        
        try {
            // Load models from CDN
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            await faceapi.nets.faceRecognitionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            await faceapi.nets.faceExpressionNet.loadFromUri('https://justadudewhohacks.github.io/face-api.js/models');
            
            modelsLoaded = true;
            modelLoading.classList.add('hidden');
            
            // Start video for registration
            startVideo();
            
            // Start video for attendance
            startAttendanceVideo();
            
            showMessage('Models loaded successfully!', 'success');
        } catch (error) {
            console.error('Error loading models:', error);
            modelLoading.classList.add('hidden');
            showMessage('Error loading face recognition models. Please check your internet connection.', 'error');
        }
    }

    // Start video for registration
    async function startVideo() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: 640, 
                    height: 480,
                    facingMode: currentCamera
                } 
            });
            video.srcObject = stream;
        } catch (error) {
            console.error('Error accessing camera:', error);
            showMessage('Error accessing camera. Please ensure you have granted camera permissions.', 'error');
        }
    }

    // Start video for attendance
    async function startAttendanceVideo() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { 
                    width: 640, 
                    height: 480,
                    facingMode: currentCamera
                } 
            });
            attendanceVideo.srcObject = stream;
        } catch (error) {
            console.error('Error accessing camera:', error);
            showMessage('Error accessing camera. Please ensure you have granted camera permissions.', 'error');
        }
    }

    // Switch camera between front and rear
    async function switchCamera() {
        // Stop current streams
        if (video.srcObject) {
            video.srcObject.getTracks().forEach(track => track.stop());
        }
        
        // Toggle camera
        currentCamera = currentCamera === 'user' ? 'environment' : 'user';
        
        // Restart video with new camera
        await startVideo();
        
        showMessage(`Switched to ${currentCamera === 'user' ? 'front' : 'rear'} camera`, 'info');
    }

    // Switch camera for attendance
    async function switchAttendanceCamera() {
        // Stop current streams
        if (attendanceVideo.srcObject) {
            attendanceVideo.srcObject.getTracks().forEach(track => track.stop());
        }
        
        // Toggle camera
        currentCamera = currentCamera === 'user' ? 'environment' : 'user';
        
        // Restart video with new camera
        await startAttendanceVideo();
        
        showMessage(`Switched to ${currentCamera === 'user' ? 'front' : 'rear'} camera`, 'info', 'attendance-message');
    }

    // Capture face for registration
    async function captureFace() {
        if (!modelsLoaded) {
            showMessage('Face recognition models are still loading. Please wait.', 'error');
            return;
        }
        
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const livenessIndicator = document.getElementById('liveness-indicator');
        
        captureBtn.disabled = true;
        livenessIndicator.classList.remove('hidden');
        
        try {
            // Enhanced liveness detection for registration
            const isLive = await performEnhancedLivenessCheck(video);
            
            if (!isLive) {
                showMessage('Liveness check failed. Please ensure you are a real person.', 'error');
                captureBtn.disabled = false;
                livenessIndicator.classList.add('hidden');
                return;
            }
            
            livenessIndicator.querySelector('.liveness-dot').classList.add('active');
            livenessIndicator.querySelector('span').textContent = 'Liveness verified!';
            
            // Draw video frame to canvas
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Detect faces
            const detections = await faceapi
                .detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors();
            
            if (detections.length === 0) {
                showMessage('No face detected. Please try again.', 'error');
                captureBtn.disabled = false;
                livenessIndicator.classList.add('hidden');
                return;
            }
            
            if (detections.length > 1) {
                showMessage('Multiple faces detected. Please ensure only one person is in the frame.', 'error');
                captureBtn.disabled = false;
                livenessIndicator.classList.add('hidden');
                return;
            }
            
            // Show success
            showMessage('Face captured successfully!', 'success');
            captureBtn.classList.add('hidden');
            retakeBtn.classList.remove('hidden');
            canvas.classList.remove('hidden');
            video.classList.add('hidden');
            
            captureBtn.disabled = false;
        } catch (error) {
            console.error('Error capturing face:', error);
            showMessage('Error capturing face. Please try again.', 'error');
            captureBtn.disabled = false;
            livenessIndicator.classList.add('hidden');
        }
    }

    // Enhanced liveness check for registration
    async function performEnhancedLivenessCheck(videoElement) {
        return new Promise((resolve) => {
            let checksCompleted = 0;
            const totalChecks = 4;
            let passedChecks = 0;
            
            const performCheck = async () => {
                try {
                    const detections = await faceapi
                        .detectAllFaces(videoElement, new faceapi.TinyFaceDetectorOptions())
                        .withFaceLandmarks()
                        .withFaceExpressions();
                    
                    if (detections.length === 0) {
                        resolve(false);
                        return;
                    }
                    
                    // Check 1: Basic movement detection
                    const movementPassed = await checkMovement(detections[0]);
                    if (movementPassed) passedChecks++;
                    
                    // Check 2: Blink detection
                    const blinkPassed = await checkBlinkDetection(detections[0]);
                    if (blinkPassed) passedChecks++;
                    
                    // Check 3: Natural expressions
                    const expressionPassed = checkNaturalExpressions(detections[0]);
                    if (expressionPassed) passedChecks++;
                    
                    // Check 4: Texture analysis (simulated)
                    const texturePassed = await simulateTextureAnalysis();
                    if (texturePassed) passedChecks++;
                    
                    checksCompleted++;
                    
                    if (checksCompleted >= totalChecks) {
                        // Require at least 3 out of 4 checks to pass
                        resolve(passedChecks >= 3);
                    } else {
                        setTimeout(performCheck, 1000);
                    }
                } catch (error) {
                    console.error('Error in liveness check:', error);
                    resolve(false);
                }
            };
            
            performCheck();
        });
    }

    // Retake face capture
    function retakeFace() {
        const captureBtn = document.getElementById('capture-btn');
        const retakeBtn = document.getElementById('retake-btn');
        const livenessIndicator = document.getElementById('liveness-indicator');
        
        captureBtn.classList.remove('hidden');
        retakeBtn.classList.add('hidden');
        canvas.classList.add('hidden');
        video.classList.remove('hidden');
        
        livenessIndicator.classList.add('hidden');
        livenessIndicator.querySelector('.liveness-dot').classList.remove('active');
        livenessIndicator.querySelector('span').textContent = 'Verifying liveness...';
        
        showMessage('', 'success');
    }

    // Save student
    async function saveStudent() {
        const name = document.getElementById('name').value;
        const regNumber = document.getElementById('reg-number').value;
        
        if (!name || !regNumber) {
            showMessage('Please enter both name and registration number.', 'error', 'register-message');
            return;
        }
        
        if (canvas.classList.contains('hidden')) {
            showMessage('Please capture a face image first.', 'error', 'register-message');
            return;
        }
        
        try {
            // Get face descriptor from captured image
            const detections = await faceapi
                .detectAllFaces(canvas, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors();
            
            if (detections.length === 0) {
                showMessage('No face detected in the captured image. Please retake.', 'error', 'register-message');
                return;
            }
            
            // Convert descriptor to array for storage
            const descriptorArray = Array.from(detections[0].descriptor);
            
            // Check if student already exists
            const existingStudent = students.find(s => s.regNumber === regNumber);
            if (existingStudent) {
                showMessage('Student with this registration number already exists.', 'error', 'register-message');
                return;
            }
            
            // Create student object
            const student = {
                id: Date.now().toString(),
                name,
                regNumber,
                faceDescriptor: descriptorArray,
                enrolledDate: new Date().toISOString()
            };
            
            // Save to localStorage
            students.push(student);
            localStorage.setItem('students', JSON.stringify(students));
            
            showMessage(`Student ${name} registered successfully!`, 'success', 'register-message');
            
            // Reset form
            document.getElementById('name').value = '';
            document.getElementById('reg-number').value = '';
            retakeFace();
            
            // Update students table
            loadStudentsTable();
            updateStats();
            generateRecommendations();
        } catch (error) {
            console.error('Error saving student:', error);
            showMessage('Error saving student. Please try again.', 'error', 'register-message');
        }
    }

    // Start attendance session
    async function startAttendance() {
        if (!modelsLoaded) {
            showMessage('Face recognition models are still loading. Please wait.', 'error', 'attendance-message');
            return;
        }
        
        const sessionName = document.getElementById('session-name').value;
        if (!sessionName) {
            showMessage('Please enter a session name.', 'error', 'attendance-message');
            return;
        }
        
        if (students.length === 0) {
            showMessage('No students registered. Please register students first.', 'error', 'attendance-message');
            return;
        }
        
        // Load labeled face descriptors
        const labeledFaceDescriptors = await loadLabeledFaceDescriptors(students);
        if (labeledFaceDescriptors.length === 0) {
            showMessage('No valid face descriptors found. Please register students with clear face images.', 'error', 'attendance-message');
            return;
        }
        
        // Create face matcher
        const faceMatcher = new faceapi.FaceMatcher(labeledFaceDescriptors, getRecognitionThreshold());
        
        // Set up attendance session
        currentSession = {
            id: Date.now().toString(),
            name: sessionName,
            date: document.getElementById('attendance-date').value,
            startTime: new Date(),
            timeLimit: parseInt(document.getElementById('time-limit').value),
            attendees: [],
            faceMatcher: faceMatcher,
            markedStudents: new Set() // Track which students have been marked
        };
        
        // Save session
        attendanceSessions.push({
            id: currentSession.id,
            name: currentSession.name,
            date: currentSession.date,
            startTime: currentSession.startTime.toISOString(),
            timeLimit: currentSession.timeLimit
        });
        localStorage.setItem('attendanceSessions', JSON.stringify(attendanceSessions));
        
        // Start timer
        timeRemaining = currentSession.timeLimit * 60;
        updateTimerDisplay();
        document.getElementById('timer-panel').classList.remove('hidden');
        
        // Start attendance detection
        isCapturing = true;
        document.getElementById('start-attendance').classList.add('hidden');
        document.getElementById('stop-attendance').classList.remove('hidden');
        
        // Show security indicators
        document.getElementById('liveness-verification').classList.remove('hidden');
        updateSecurityScore();
        resetVerificationSteps();
        
        // Start timer countdown
        attendanceTimer = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();
            
            if (timeRemaining <= 0) {
                stopAttendance();
            }
        }, 1000);
        
        // Start face detection for attendance
        detectFacesForAttendance();
        
        showMessage(`Attendance session "${sessionName}" started! Enhanced anti-spoofing active.`, 'success', 'attendance-message');
    }

    // Load labeled face descriptors from students
    async function loadLabeledFaceDescriptors(students) {
        const labeledFaceDescriptors = [];
        
        for (const student of students) {
            if (student.faceDescriptor && student.faceDescriptor.length > 0) {
                // Convert array back to Float32Array
                const descriptor = new Float32Array(student.faceDescriptor);
                const labeledFaceDescriptor = new faceapi.LabeledFaceDescriptors(
                    student.regNumber,
                    [descriptor]
                );
                labeledFaceDescriptors.push(labeledFaceDescriptor);
            }
        }
        
        return labeledFaceDescriptors;
    }

    // Detect faces for attendance in real-time
    async function detectFacesForAttendance() {
        if (!isCapturing) return;
        
        try {
            // Set canvas dimensions
            attendanceCanvas.width = attendanceVideo.videoWidth;
            attendanceCanvas.height = attendanceVideo.videoHeight;
            
            // Detect faces with enhanced features
            const detections = await faceapi
                .detectAllFaces(attendanceVideo, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptors()
                .withFaceExpressions();
            
            // Clear previous overlays
            const overlays = document.getElementById('attendance-overlays');
            overlays.innerHTML = '';
            
            // Reset verification steps if no faces detected
            if (detections.length === 0) {
                resetVerificationSteps();
                livenessCheckInProgress = false;
                livenessVerificationHistory = [];
                blinkDetectionHistory = [];
                currentChallenge = null;
                document.getElementById('challenge-prompt').classList.add('hidden');
                return;
            }
            
            // Process each detection
            for (const detection of detections) {
                const bestMatch = currentSession.faceMatcher.findBestMatch(detection.descriptor);
                
                // Draw face box
                const { x, y, width, height } = detection.detection.box;
                const overlay = document.createElement('div');
                overlay.className = 'face-overlay';
                overlay.style.left = `${x}px`;
                overlay.style.top = `${y}px`;
                overlay.style.width = `${width}px`;
                overlay.style.height = `${height}px`;
                
                // Add label
                const label = document.createElement('div');
                label.className = 'face-label';
                
                // Ensure percentage doesn't exceed 100%
                const confidence = Math.min(100, Math.round((1 - bestMatch.distance) * 100));
                
                if (bestMatch.distance < getRecognitionThreshold()) {
                    // Update verification steps
                    updateVerificationStep('step-face-detected', true);
                    
                    // Enhanced anti-spoofing verification
                    if (settings.requireLiveness && !currentSession.markedStudents.has(bestMatch.label)) {
                        const verificationResult = await performEnhancedAntiSpoofing(detection, bestMatch.label);
                        
                        if (verificationResult.passed) {
                            updateVerificationStep('step-attendance-marked', true);
                            recordAttendance(bestMatch.label, confidence);
                            currentSession.markedStudents.add(bestMatch.label);
                            
                            // Reset verification after successful marking
                            setTimeout(() => {
                                resetVerificationSteps();
                                livenessCheckInProgress = false;
                                livenessVerificationHistory = [];
                                blinkDetectionHistory = [];
                                currentChallenge = null;
                                document.getElementById('challenge-prompt').classList.add('hidden');
                            }, 2000);
                            
                            label.textContent = `${bestMatch.label} (${confidence}%) - Verified`;
                            overlay.style.borderColor = 'var(--success)';
                            label.style.backgroundColor = 'rgba(76, 201, 240, 0.8)';
                        } else {
                            label.textContent = `${bestMatch.label} - ${verificationResult.reason}`;
                            overlay.style.borderColor = 'var(--danger)';
                            label.style.backgroundColor = 'rgba(247, 37, 133, 0.8)';
                        }
                    } else if (!settings.requireLiveness && !currentSession.markedStudents.has(bestMatch.label)) {
                        // No anti-spoofing required, mark attendance directly
                        updateVerificationStep('step-attendance-marked', true);
                        recordAttendance(bestMatch.label, confidence);
                        currentSession.markedStudents.add(bestMatch.label);
                        
                        label.textContent = `${bestMatch.label} (${confidence}%)`;
                        overlay.style.borderColor = 'var(--success)';
                        label.style.backgroundColor = 'rgba(76, 201, 240, 0.8)';
                    } else if (currentSession.markedStudents.has(bestMatch.label)) {
                        // Already marked
                        label.textContent = `${bestMatch.label} - Already marked`;
                        overlay.style.borderColor = 'var(--info)';
                        label.style.backgroundColor = 'rgba(114, 9, 183, 0.8)';
                    } else {
                        // Anti-spoofing in progress
                        label.textContent = `${bestMatch.label} - Verifying...`;
                        overlay.style.borderColor = 'var(--warning)';
                        label.style.backgroundColor = 'rgba(248, 150, 30, 0.8)';
                    }
                } else {
                    label.textContent = `Unknown (${confidence}%)`;
                    overlay.style.borderColor = 'var(--danger)';
                    label.style.backgroundColor = 'rgba(247, 37, 133, 0.8)';
                }
                
                overlay.appendChild(label);
                overlays.appendChild(overlay);
            }
            
            // Continue detection
            if (isCapturing) {
                setTimeout(() => detectFacesForAttendance(), 800);
            }
        } catch (error) {
            console.error('Error detecting faces:', error);
            
            // Continue detection even if there's an error
            if (isCapturing) {
                setTimeout(() => detectFacesForAttendance(), 1000);
            }
        }
    }

    // Enhanced anti-spoofing verification
    async function performEnhancedAntiSpoofing(detection, studentId) {
        return new Promise(async (resolve) => {
            let passedChecks = 0;
            const totalChecks = 4;
            let failureReason = 'Anti-spoofing failed';
            
            try {
                // Check 1: Movement detection
                updateVerificationStep('step-movement-check', true);
                const movementPassed = await checkMovement(detection);
                if (movementPassed) passedChecks++;
                
                // Check 2: Blink detection (if enabled)
                if (settings.enableBlinkDetection) {
                    updateVerificationStep('step-blink-detection', true);
                    const blinkPassed = await checkBlinkDetection(detection);
                    if (blinkPassed) passedChecks++;
                } else {
                    passedChecks++; // Skip this check
                }
                
                // Check 3: Challenge-response (if enabled)
                if (settings.enableChallenge) {
                    updateVerificationStep('step-challenge-response', true);
                    const challengePassed = await performChallengeResponse(detection);
                    if (challengePassed) passedChecks++;
                } else {
                    passedChecks++; // Skip this check
                }
                
                // Check 4: Texture and expression analysis
                const texturePassed = await simulateTextureAnalysis();
                const expressionPassed = checkNaturalExpressions(detection);
                if (texturePassed && expressionPassed) passedChecks++;
                
                // Determine result based on security level
                let requiredPasses;
                switch(settings.securityLevel) {
                    case 'low':
                        requiredPasses = 2; // 50%
                        break;
                    case 'medium':
                        requiredPasses = 3; // 75%
                        break;
                    case 'high':
                        requiredPasses = 4; // 100%
                        break;
                    default:
                        requiredPasses = 3;
                }
                
                if (passedChecks >= requiredPasses) {
                    resolve({ passed: true });
                } else {
                    failureReason = `Failed ${totalChecks - passedChecks} security checks`;
                    resolve({ passed: false, reason: failureReason });
                }
                
            } catch (error) {
                console.error('Error in anti-spoofing:', error);
                resolve({ passed: false, reason: 'Verification error' });
            }
        });
    }

    // Movement detection
    async function checkMovement(detection) {
        return new Promise((resolve) => {
            const position = detection.detection.box;
            livenessVerificationHistory.push({
                time: Date.now(),
                position: position
            });
            
            // Keep only recent history (last 5 seconds)
            livenessVerificationHistory = livenessVerificationHistory.filter(
                item => Date.now() - item.time < 5000
            );
            
            if (livenessVerificationHistory.length >= 3) {
                let totalMovement = 0;
                for (let i = 1; i < livenessVerificationHistory.length; i++) {
                    const prev = livenessVerificationHistory[i-1].position;
                    const curr = livenessVerificationHistory[i].position;
                    totalMovement += Math.sqrt(
                        Math.pow(curr.x - prev.x, 2) + 
                        Math.pow(curr.y - prev.y, 2)
                    );
                }
                
                // Different thresholds based on security level
                let threshold = 20;
                if (settings.securityLevel === 'high') threshold = 30;
                if (settings.securityLevel === 'low') threshold = 10;
                
                resolve(totalMovement > threshold);
            } else {
                resolve(false);
            }
        });
    }

    // Blink detection
    async function checkBlinkDetection(detection) {
        return new Promise((resolve) => {
            const landmarks = detection.landmarks;
            if (landmarks && landmarks.positions) {
                // Simple blink detection using eye landmarks
                const leftEye = landmarks.getLeftEye();
                const rightEye = landmarks.getRightEye();
                
                const leftEyeHeight = Math.abs(leftEye[1].y - leftEye[5].y);
                const rightEyeHeight = Math.abs(rightEye[1].y - rightEye[5].y);
                
                const blinkThreshold = 5; // pixels
                const isBlinking = leftEyeHeight < blinkThreshold || rightEyeHeight < blinkThreshold;
                
                blinkDetectionHistory.push({
                    time: Date.now(),
                    isBlinking: isBlinking
                });
                
                // Keep only recent history
                blinkDetectionHistory = blinkDetectionHistory.filter(
                    item => Date.now() - item.time < 3000
                );
                
                // Check for blink patterns (at least 1 blink in last 3 seconds)
                const hasBlinked = blinkDetectionHistory.some(item => item.isBlinking);
                resolve(hasBlinked);
            } else {
                resolve(false);
            }
        });
    }

    // Challenge-response verification
    async function performChallengeResponse(detection) {
        return new Promise((resolve) => {
            if (!currentChallenge) {
                // Start new challenge
                currentChallenge = CHALLENGES[Math.floor(Math.random() * CHALLENGES.length)];
                challengeStartTime = Date.now();
                document.getElementById('challenge-prompt').classList.remove('hidden');
                document.getElementById('challenge-text').textContent = currentChallenge.instruction;
            }
            
            const landmarks = detection.landmarks;
            if (!landmarks) {
                resolve(false);
                return;
            }
            
            let challengePassed = false;
            
            switch(currentChallenge.type) {
                case 'head_turn':
                    // Check head pose based on facial landmarks
                    const nose = landmarks.positions[30]; // Nose tip
                    const leftEye = landmarks.positions[36]; // Left eye corner
                    const rightEye = landmarks.positions[45]; // Right eye corner
                    
                    const eyeDistance = Math.abs(rightEye.x - leftEye.x);
                    const noseOffset = Math.abs(nose.x - (leftEye.x + rightEye.x) / 2);
                    
                    if (currentChallenge.direction === 'left') {
                        challengePassed = noseOffset > eyeDistance * 0.2 && nose.x < (leftEye.x + rightEye.x) / 2;
                    } else if (currentChallenge.direction === 'right') {
                        challengePassed = noseOffset > eyeDistance * 0.2 && nose.x > (leftEye.x + rightEye.x) / 2;
                    } else if (currentChallenge.direction === 'up') {
                        // Simplified up/down detection
                        challengePassed = nose.y < Math.min(leftEye.y, rightEye.y) - 10;
                    } else if (currentChallenge.direction === 'down') {
                        challengePassed = nose.y > Math.max(leftEye.y, rightEye.y) + 10;
                    }
                    break;
                    
                case 'blink':
                    // Already handled in blink detection
                    challengePassed = blinkDetectionHistory.filter(item => item.isBlinking).length >= currentChallenge.count;
                    break;
                    
                case 'smile':
                    const expressions = detection.expressions;
                    if (expressions) {
                        challengePassed = expressions.happy > 0.7;
                    }
                    break;
            }
            
            // Timeout after 10 seconds
            if (Date.now() - challengeStartTime > 10000) {
                currentChallenge = null;
                document.getElementById('challenge-prompt').classList.add('hidden');
                resolve(false);
            } else if (challengePassed) {
                currentChallenge = null;
                document.getElementById('challenge-prompt').classList.add('hidden');
                resolve(true);
            } else {
                resolve(false);
            }
        });
    }

    // Natural expression check
    function checkNaturalExpressions(detection) {
        const expressions = detection.expressions;
        if (!expressions) return true;
        
        // Check for neutral or natural expressions (not extreme values)
        const neutralScore = expressions.neutral || 0;
        const hasNaturalExpression = neutralScore > 0.3 || 
                                   (expressions.happy > 0.1 && expressions.happy < 0.8) ||
                                   (expressions.surprised > 0.1 && expressions.surprised < 0.7);
        
        return hasNaturalExpression;
    }

    // Simulated texture analysis (in real implementation, this would use more advanced techniques)
    async function simulateTextureAnalysis() {
        return new Promise((resolve) => {
            // Simulate texture analysis that would detect screen/paper
            // In a real implementation, this would analyze image quality, reflections, etc.
            const isReal = Math.random() > 0.1; // 90% success rate for simulation
            resolve(isReal);
        });
    }

    // Update verification steps
    function updateVerificationStep(stepId, completed) {
        const step = document.getElementById(stepId);
        const icon = step.querySelector('i');
        
        if (completed) {
            step.className = 'verification-step step-complete';
            icon.className = 'fas fa-check-circle';
        } else {
            step.className = 'verification-step step-active';
            icon.className = 'fas fa-spinner fa-spin';
        }
    }

    // Reset verification steps
    function resetVerificationSteps() {
        const steps = ['step-face-detected', 'step-movement-check', 'step-blink-detection', 'step-challenge-response', 'step-attendance-marked'];
        steps.forEach(stepId => {
            const step = document.getElementById(stepId);
            const icon = step.querySelector('i');
            
            step.className = 'verification-step step-pending';
            
            if (stepId === 'step-face-detected') {
                icon.className = 'fas fa-user';
            } else if (stepId === 'step-movement-check') {
                icon.className = 'fas fa-arrows-alt';
            } else if (stepId === 'step-blink-detection') {
                icon.className = 'fas fa-eye';
            } else if (stepId === 'step-challenge-response') {
                icon.className = 'fas fa-random';
            } else {
                icon.className = 'fas fa-check-circle';
            }
        });
    }

    // Update security score display
    function updateSecurityScore() {
        const scoreElement = document.getElementById('security-score');
        let scoreText, scoreClass;
        
        switch(settings.securityLevel) {
            case 'low':
                scoreText = 'Basic';
                scoreClass = 'score-low';
                break;
            case 'medium':
                scoreText = 'High';
                scoreClass = 'score-medium';
                break;
            case 'high':
                scoreText = 'Maximum';
                scoreClass = 'score-high';
                break;
            default:
                scoreText = 'High';
                scoreClass = 'score-medium';
        }
        
        scoreElement.textContent = scoreText;
        scoreElement.className = `security-score ${scoreClass}`;
    }

    // Record attendance for a student
    function recordAttendance(regNumber, confidence) {
        // Find student details
        const student = students.find(s => s.regNumber === regNumber);
        
        if (student) {
            const currentTime = new Date();
            const sessionStartTime = new Date(currentSession.startTime);
            const minutesLate = Math.max(0, Math.floor((currentTime - sessionStartTime) / (1000 * 60)) - settings.lateThreshold);
            const isLate = minutesLate > 0;
            
            const attendanceRecord = {
                id: Date.now().toString(),
                regNumber,
                name: student.name,
                timestamp: currentTime,
                confidence,
                status: isLate ? 'Late' : 'Present',
                sessionName: currentSession.name,
                date: currentSession.date,
                minutesLate: isLate ? minutesLate : 0,
                securityLevel: settings.securityLevel,
                antiSpoofingUsed: settings.requireLiveness
            };
            
            currentSession.attendees.push(attendanceRecord);
            
            // Save to attendance records
            attendanceRecords.push(attendanceRecord);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            updateCurrentAttendanceTable();
            updateStats();
            loadAllSessions();
            generateRecommendations();
            
            const statusText = isLate ? `late (${minutesLate} min)` : 'present';
            showMessage(`${student.name} marked ${statusText} with enhanced security!`, 'success', 'attendance-message');
        }
    }

    // Stop attendance session
    function stopAttendance() {
        isCapturing = false;
        livenessCheckInProgress = false;
        
        if (attendanceTimer) {
            clearInterval(attendanceTimer);
            attendanceTimer = null;
        }
        
        document.getElementById('start-attendance').classList.remove('hidden');
        document.getElementById('stop-attendance').classList.add('hidden');
        document.getElementById('timer-panel').classList.add('hidden');
        document.getElementById('liveness-verification').classList.add('hidden');
        document.getElementById('challenge-prompt').classList.add('hidden');
        
        // Clear face overlays
        document.getElementById('attendance-overlays').innerHTML = '';
        
        if (currentSession) {
            // Mark absent students
            const absentStudents = students.filter(student => 
                !currentSession.attendees.some(attendee => attendee.regNumber === student.regNumber)
            );
            
            absentStudents.forEach(student => {
                const absentRecord = {
                    id: Date.now().toString() + Math.random(),
                    regNumber: student.regNumber,
                    name: student.name,
                    timestamp: new Date(),
                    confidence: 0,
                    status: 'Absent',
                    sessionName: currentSession.name,
                    date: currentSession.date,
                    minutesLate: 0,
                    securityLevel: settings.securityLevel,
                    antiSpoofingUsed: settings.requireLiveness
                };
                
                attendanceRecords.push(absentRecord);
            });
            
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            const presentCount = currentSession.attendees.length;
            const absentCount = absentStudents.length;
            showMessage(`Attendance session "${currentSession.name}" completed! ${presentCount} students marked present, ${absentCount} absent. Enhanced security was ${settings.requireLiveness ? 'enabled' : 'disabled'}.`, 'success', 'attendance-message');
            currentSession = null;
            
            // Update analytics
            updateStats();
            loadAllSessions();
            generateRecommendations();
            // Update charts if they exist
            if (charts.attendanceTrend) {
                updateChartsWithData();
            }
        }
    }

    // Extend time for attendance session
    function extendTime() {
        timeRemaining += 300; // Add 5 minutes
        updateTimerDisplay();
        showMessage('Time extended by 5 minutes!', 'info', 'attendance-message');
    }

    // Update timer display
    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        document.getElementById('timer-display').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when time is running out
        if (timeRemaining < 60) {
            document.getElementById('timer-display').style.color = 'var(--danger)';
            document.getElementById('timer-display').classList.add('blink');
        } else if (timeRemaining < 300) {
            document.getElementById('timer-display').style.color = 'var(--warning)';
            document.getElementById('timer-display').classList.remove('blink');
        } else {
            document.getElementById('timer-display').style.color = 'var(--primary)';
            document.getElementById('timer-display').classList.remove('blink');
        }
    }

    // Update threshold value display
    function updateThresholdValue() {
        const threshold = document.getElementById('recognition-threshold').value;
        document.getElementById('threshold-value').textContent = threshold;
    }

    // Update default threshold value display
    function updateDefaultThresholdValue() {
        const threshold = document.getElementById('default-recognition-threshold').value;
        document.getElementById('default-threshold-value').textContent = threshold;
        saveSettings();
    }

    // Get recognition threshold value
    function getRecognitionThreshold() {
        return parseFloat(document.getElementById('recognition-threshold').value);
    }

    // Update current attendance table
    function updateCurrentAttendanceTable() {
        if (!currentSession) return;
        
        const tbody = document.querySelector('#current-attendance tbody');
        tbody.innerHTML = '';
        
        currentSession.attendees.forEach(attendee => {
            const row = document.createElement('tr');
            
            // Ensure confidence doesn't exceed 100%
            const confidence = Math.min(100, attendee.confidence);
            
            row.innerHTML = `
                <td>${attendee.regNumber}</td>
                <td>${attendee.name}</td>
                <td>
                    <div class="attendance-status">
                        <span class="status-dot ${attendee.status.toLowerCase()}"></span>
                        <span>${attendee.status}${attendee.minutesLate > 0 ? ` (${attendee.minutesLate} min)` : ''}</span>
                    </div>
                </td>
                <td>${attendee.timestamp.toLocaleTimeString()}</td>
                <td>${confidence}%</td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Load students table with enhanced information
    function loadStudentsTable() {
        const tbody = document.querySelector('#students-table tbody');
        tbody.innerHTML = '';
        
        if (students.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No students registered yet</td></tr>';
            return;
        }
        
        students.forEach(student => {
            const row = document.createElement('tr');
            
            // Calculate student statistics
            const studentRecords = attendanceRecords.filter(record => record.regNumber === student.regNumber);
            const presentRecords = studentRecords.filter(record => record.status === 'Present' || record.status === 'Late');
            const attendanceRate = studentRecords.length > 0 ? 
                Math.round((presentRecords.length / studentRecords.length) * 100) : 0;
            
            // Calculate punctuality (percentage of on-time arrivals)
            const onTimeRecords = studentRecords.filter(record => record.status === 'Present');
            const punctualityRate = studentRecords.length > 0 ? 
                Math.round((onTimeRecords.length / studentRecords.length) * 100) : 0;
            
            // Get last attendance date
            const lastAttendance = studentRecords.length > 0 ? 
                new Date(Math.max(...studentRecords.map(r => new Date(r.timestamp)))) : null;
            const lastAttendanceText = lastAttendance ? 
                lastAttendance.toLocaleDateString() : 'Never';
            
            row.innerHTML = `
                <td>${student.regNumber}</td>
                <td>${student.name}</td>
                <td>${attendanceRate}%</td>
                <td>${punctualityRate}%</td>
                <td>${lastAttendanceText}</td>
                <td class="action-btns">
                    <button class="btn btn-danger btn-sm" onclick="deleteStudent('${student.regNumber}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Delete student
    function deleteStudent(regNumber) {
        if (confirm(`Are you sure you want to delete student ${regNumber}?`)) {
            // Remove from students array
            students = students.filter(s => s.regNumber !== regNumber);
            localStorage.setItem('students', JSON.stringify(students));
            
            // Remove from attendance records
            attendanceRecords = attendanceRecords.filter(r => r.regNumber !== regNumber);
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            
            showMessage(`Student ${regNumber} deleted successfully!`, 'success');
            loadStudentsTable();
            updateStats();
            generateRecommendations();
        }
    }

    // Load all sessions with detailed information
    function loadAllSessions() {
        const container = document.getElementById('sessions-container');
        const filterDate = document.getElementById('session-filter').value;
        
        // Filter sessions if date is selected
        let filteredSessions = attendanceSessions;
        if (filterDate) {
            filteredSessions = attendanceSessions.filter(session => session.date === filterDate);
        }
        
        if (filteredSessions.length === 0) {
            container.innerHTML = '<div class="session-card"><p style="text-align: center;">No sessions found for the selected date</p></div>';
            return;
        }
        
        container.innerHTML = '';
        
        filteredSessions.forEach(session => {
            const sessionCard = document.createElement('div');
            sessionCard.className = 'session-card';
            
            // Get attendance records for this session
            const sessionRecords = attendanceRecords.filter(record => 
                record.sessionName === session.name && record.date === session.date
            );
            
            const presentCount = sessionRecords.filter(record => record.status === 'Present' || record.status === 'Late').length;
            const lateCount = sessionRecords.filter(record => record.status === 'Late').length;
            const absentCount = students.length - presentCount;
            const attendanceRate = students.length > 0 ? Math.round((presentCount / students.length) * 100) : 0;
            
            sessionCard.innerHTML = `
                <div class="session-header">
                    <div class="session-title">${session.name}</div>
                    <div class="session-meta">
                        <span><i class="fas fa-calendar"></i> ${session.date}</span>
                        <span><i class="fas fa-clock"></i> ${new Date(session.startTime).toLocaleTimeString()}</span>
                    </div>
                </div>
                <div class="session-stats">
                    <div class="session-stat">
                        <div class="session-stat-value">${attendanceRate}%</div>
                        <div class="session-stat-label">Attendance Rate</div>
                    </div>
                    <div class="session-stat">
                        <div class="session-stat-value">${presentCount}</div>
                        <div class="session-stat-label">Present</div>
                    </div>
                    <div class="session-stat">
                        <div class="session-stat-value">${lateCount}</div>
                        <div class="session-stat-label">Late</div>
                    </div>
                    <div class="session-stat">
                        <div class="session-stat-value">${absentCount}</div>
                        <div class="session-stat-label">Absent</div>
                    </div>
                    <div class="session-stat">
                        <div class="session-stat-value">${students.length}</div>
                        <div class="session-stat-label">Total Students</div>
                    </div>
                    <div class="session-stat">
                        <div class="session-stat-value">${session.timeLimit}</div>
                        <div class="session-stat-label">Duration (min)</div>
                    </div>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-sm" onclick="viewSessionDetails('${session.id}')">
                        <i class="fas fa-eye"></i> View Details
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="exportSession('${session.id}')">
                        <i class="fas fa-download"></i> Export
                    </button>
                </div>
            `;
            
            container.appendChild(sessionCard);
        });
    }

    // View session details
    function viewSessionDetails(sessionId) {
        const session = attendanceSessions.find(s => s.id === sessionId);
        if (!session) return;
        
        // Filter records for this session
        const sessionRecords = attendanceRecords.filter(record => 
            record.sessionName === session.name && record.date === session.date
        );
        
        // Generate a detailed report
        let reportHTML = `
            <h3>Session Details: ${session.name}</h3>
            <p><strong>Date:</strong> ${session.date}</p>
            <p><strong>Start Time:</strong> ${new Date(session.startTime).toLocaleTimeString()}</p>
            <p><strong>Duration:</strong> ${session.timeLimit} minutes</p>
            <hr>
            <h4>Attendance Summary</h4>
            <table>
                <thead>
                    <tr>
                        <th>Student</th>
                        <th>Status</th>
                        <th>Time</th>
                        <th>Confidence</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        students.forEach(student => {
            const record = sessionRecords.find(r => r.regNumber === student.regNumber);
            if (record) {
                reportHTML += `
                    <tr>
                        <td>${student.name} (${student.regNumber})</td>
                        <td>${record.status}${record.minutesLate > 0 ? ` (${record.minutesLate} min late)` : ''}</td>
                        <td>${new Date(record.timestamp).toLocaleTimeString()}</td>
                        <td>${Math.min(100, record.confidence)}%</td>
                    </tr>
                `;
            } else {
                reportHTML += `
                    <tr>
                        <td>${student.name} (${student.regNumber})</td>
                        <td>Absent</td>
                        <td>-</td>
                        <td>-</td>
                    </tr>
                `;
            }
        });
        
        reportHTML += `
                </tbody>
            </table>
        `;
        
        // Open in new window
        const newWindow = window.open('', '_blank');
        newWindow.document.write(`
            <html>
                <head>
                    <title>Session Details: ${session.name}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${reportHTML}
                </body>
            </html>
        `);
        newWindow.document.close();
    }

    // Export session data
    function exportSession(sessionId) {
        const session = attendanceSessions.find(s => s.id === sessionId);
        if (!session) return;
        
        // Filter records for this session
        const sessionRecords = attendanceRecords.filter(record => 
            record.sessionName === session.name && record.date === session.date
        );
        
        let csv = 'Registration Number,Name,Status,Time,Confidence,Minutes Late\n';
        
        students.forEach(student => {
            const record = sessionRecords.find(r => r.regNumber === student.regNumber);
            if (record) {
                csv += `"${student.regNumber}","${student.name}","${record.status}","${new Date(record.timestamp).toLocaleTimeString()}","${Math.min(100, record.confidence)}%","${record.minutesLate}"\n`;
            } else {
                csv += `"${student.regNumber}","${student.name}","Absent","-","-","0"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_${session.name}_${session.date}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('Session exported successfully!', 'success');
    }

    // Generate attendance report
    function generateReport() {
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const session = document.getElementById('report-session').value;
        
        const tbody = document.querySelector('#report-table tbody');
        tbody.innerHTML = '';
        
        // Filter records by date range and session
        let filteredRecords = attendanceRecords.filter(record => {
            const recordDate = new Date(record.date);
            const start = new Date(startDate);
            const end = new Date(endDate);
            return recordDate >= start && recordDate <= end;
        });
        
        if (session) {
            filteredRecords = filteredRecords.filter(record => record.sessionName === session);
        }
        
        if (filteredRecords.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No attendance records found for the selected criteria</td></tr>';
            return;
        }
        
        // Get all students and create a complete report with present, late, and absent
        const sessionRecords = {};
        filteredRecords.forEach(record => {
            if (!sessionRecords[record.regNumber]) {
                sessionRecords[record.regNumber] = [];
            }
            sessionRecords[record.regNumber].push(record);
        });
        
        // Create rows for all students
        students.forEach(student => {
            const row = document.createElement('tr');
            const studentRecords = sessionRecords[student.regNumber] || [];
            
            // Find the most relevant record (Present > Late > Absent)
            let displayRecord = studentRecords.find(r => r.status === 'Present') ||
                              studentRecords.find(r => r.status === 'Late') ||
                              studentRecords[0]; // Or the first record if any exists
            
            if (!displayRecord) {
                // Student is absent for this session
                displayRecord = {
                    regNumber: student.regNumber,
                    name: student.name,
                    status: 'Absent',
                    time: '-',
                    sessionName: session || 'All Sessions',
                    confidence: 0
                };
            }
            
            const time = displayRecord.timestamp ? 
                new Date(displayRecord.timestamp).toLocaleTimeString() : '-';
            
            // Ensure confidence doesn't exceed 100%
            const confidence = Math.min(100, displayRecord.confidence);
            
            row.innerHTML = `
                <td>${displayRecord.regNumber}</td>
                <td>${displayRecord.name}</td>
                <td>
                    <div class="attendance-status">
                        <span class="status-dot ${displayRecord.status.toLowerCase()}"></span>
                        <span>${displayRecord.status}${displayRecord.minutesLate > 0 ? ` (${displayRecord.minutesLate} min)` : ''}</span>
                    </div>
                </td>
                <td>${time}</td>
                <td>${displayRecord.sessionName}</td>
                <td>${confidence}%</td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Update sessions dropdown
        updateSessionsDropdown();
    }

    // Update sessions dropdown
    function updateSessionsDropdown() {
        const startDate = document.getElementById('report-start-date').value;
        const endDate = document.getElementById('report-end-date').value;
        const dropdown = document.getElementById('report-session');
        
        // Get unique session names for the selected date range
        const sessions = [...new Set(
            attendanceRecords
                .filter(record => {
                    const recordDate = new Date(record.date);
                    const start = new Date(startDate);
                    const end = new Date(endDate);
                    return recordDate >= start && recordDate <= end;
                })
                .map(record => record.sessionName)
        )];
        
        // Clear existing options except the first one
        while (dropdown.options.length > 1) {
            dropdown.remove(1);
        }
        
        // Add session options
        sessions.forEach(session => {
            const option = document.createElement('option');
            option.value = session;
            option.textContent = session;
            dropdown.appendChild(option);
        });
    }

    // Export report as CSV
    function exportReport() {
        const rows = document.querySelectorAll('#report-table tbody tr');
        if (rows.length === 0 || (rows.length === 1 && rows[0].querySelector('td').colSpan)) {
            showMessage('No data to export.', 'error');
            return;
        }
        
        let csv = 'Registration Number,Name,Status,Time,Session,Confidence\n';
        
        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            if (cells.length === 6) {
                const regNumber = cells[0].textContent;
                const name = cells[1].textContent;
                const status = cells[2].querySelector('.attendance-status span:last-child').textContent;
                const time = cells[3].textContent;
                const session = cells[4].textContent;
                const confidence = cells[5].textContent;
                
                csv += `"${regNumber}","${name}","${status}","${time}","${session}","${confidence}"\n`;
            }
        });
        
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `attendance_report_${document.getElementById('report-start-date').value}_to_${document.getElementById('report-end-date').value}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('Report exported successfully!', 'success');
    }

    // Initialize analytics charts
    function initializeCharts() {
        // Destroy existing charts if they exist
        if (charts.attendanceTrend && typeof charts.attendanceTrend.destroy === 'function') {
            charts.attendanceTrend.destroy();
        }
        if (charts.attendanceDistribution && typeof charts.attendanceDistribution.destroy === 'function') {
            charts.attendanceDistribution.destroy();
        }
        if (charts.studentPerformance && typeof charts.studentPerformance.destroy === 'function') {
            charts.studentPerformance.destroy();
        }
        if (charts.dayOfWeek && typeof charts.dayOfWeek.destroy === 'function') {
            charts.dayOfWeek.destroy();
        }

        // Attendance Trend Chart (Last 7 days)
        const trendCtx = document.getElementById('attendance-trend-chart').getContext('2d');
        charts.attendanceTrend = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Attendance Rate',
                    data: [],
                    borderColor: '#4361ee',
                    backgroundColor: 'rgba(67, 97, 238, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Attendance Distribution Chart
        const distributionCtx = document.getElementById('attendance-distribution-chart').getContext('2d');
        charts.attendanceDistribution = new Chart(distributionCtx, {
            type: 'doughnut',
            data: {
                labels: ['Present', 'Late', 'Absent'],
                datasets: [{
                    data: [0, 0, 0],
                    backgroundColor: [
                        '#4cc9f0',
                        '#f8961e',
                        '#f72585'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });
        
        // Student Performance Chart
        const performanceCtx = document.getElementById('student-performance-chart').getContext('2d');
        charts.studentPerformance = new Chart(performanceCtx, {
            type: 'bar',
            data: {
                labels: [],
                datasets: [{
                    label: 'Attendance Rate',
                    data: [],
                    backgroundColor: '#4361ee'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Day of Week Chart
        const dayCtx = document.getElementById('day-of-week-chart').getContext('2d');
        charts.dayOfWeek = new Chart(dayCtx, {
            type: 'bar',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Attendance Rate',
                    data: [0, 0, 0, 0, 0, 0, 0],
                    backgroundColor: '#4361ee'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
        
        // Update charts with initial data
        updateChartsWithData();
    }

    // Update charts with current data
    function updateChartsWithData() {
        // Check if charts exist before updating
        if (!charts.attendanceTrend || typeof charts.attendanceTrend.update !== 'function') {
            return;
        }

        // Update attendance trend (last 7 days)
        const last7Days = [];
        const trendData = [];
        
        for (let i = 6; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateString = date.toISOString().split('T')[0];
            last7Days.push(date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }));
            
            const dayRecords = attendanceRecords.filter(record => record.date === dateString);
            const presentCount = dayRecords.filter(record => record.status === 'Present' || record.status === 'Late').length;
            const attendanceRate = students.length > 0 ? Math.round((presentCount / students.length) * 100) : 0;
            trendData.push(attendanceRate);
        }
        
        charts.attendanceTrend.data.labels = last7Days;
        charts.attendanceTrend.data.datasets[0].data = trendData;
        charts.attendanceTrend.update();
        
        // Update attendance distribution (overall)
        const presentCount = attendanceRecords.filter(record => record.status === 'Present').length;
        const lateCount = attendanceRecords.filter(record => record.status === 'Late').length;
        const absentCount = (students.length * attendanceRecords.length > 0 ? 
            Math.max(0, (students.length * (new Set(attendanceRecords.map(r => r.date)).size)) - (presentCount + lateCount)) : 0);
        
        charts.attendanceDistribution.data.datasets[0].data = [presentCount, lateCount, absentCount];
        charts.attendanceDistribution.update();
        
        // Update student performance (top 10 students by attendance rate)
        const studentPerformance = students.map(student => {
            const studentRecords = attendanceRecords.filter(record => record.regNumber === student.regNumber);
            const presentRecords = studentRecords.filter(record => record.status === 'Present' || record.status === 'Late');
            const attendanceRate = studentRecords.length > 0 ? 
                Math.round((presentRecords.length / studentRecords.length) * 100) : 0;
            return {
                name: student.name,
                rate: attendanceRate
            };
        }).sort((a, b) => b.rate - a.rate).slice(0, 10);
        
        charts.studentPerformance.data.labels = studentPerformance.map(s => s.name);
        charts.studentPerformance.data.datasets[0].data = studentPerformance.map(s => s.rate);
        charts.studentPerformance.update();
        
        // Update day of week chart
        const daysOfWeek = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
        const dayData = [0, 0, 0, 0, 0, 0, 0];
        const dayCounts = [0, 0, 0, 0, 0, 0, 0];
        
        attendanceRecords.forEach(record => {
            const date = new Date(record.date);
            const dayIndex = (date.getDay() + 6) % 7; // Convert to Mon-Sun (0-6)
            if (record.status === 'Present' || record.status === 'Late') {
                dayData[dayIndex]++;
            }
            dayCounts[dayIndex]++;
        });
        
        const dayRates = dayData.map((count, index) => 
            dayCounts[index] > 0 ? Math.round((count / dayCounts[index]) * 100) : 0
        );
        
        charts.dayOfWeek.data.datasets[0].data = dayRates;
        charts.dayOfWeek.update();
    }

    // Generate student recommendations using fuzzy logic
    function generateRecommendations() {
        const container = document.getElementById('recommendations-container');
        container.innerHTML = '';
        
        if (students.length === 0) {
            container.innerHTML = '<p style="text-align: center;">No students registered yet</p>';
            return;
        }
        
        const recommendations = [];
        
        students.forEach(student => {
            const studentRecords = attendanceRecords.filter(record => record.regNumber === student.regNumber);
            
            if (studentRecords.length === 0) {
                // New student with no attendance records
                recommendations.push({
                    student: student,
                    priority: 'medium',
                    title: 'New Student',
                    content: `${student.name} has no attendance records yet. Consider following up to ensure they're aware of attendance procedures.`
                });
                return;
            }
            
            // Calculate attendance metrics
            const presentRecords = studentRecords.filter(record => record.status === 'Present' || record.status === 'Late');
            const attendanceRate = Math.round((presentRecords.length / studentRecords.length) * 100);
            const lateRecords = studentRecords.filter(record => record.status === 'Late');
            const lateRate = Math.round((lateRecords.length / studentRecords.length) * 100);
            
            // Last attendance date
            const lastAttendance = new Date(Math.max(...studentRecords.map(r => new Date(r.timestamp))));
            const daysSinceLastAttendance = Math.floor((new Date() - lastAttendance) / (1000 * 60 * 60 * 24));
            
            // Generate recommendations based on fuzzy logic
            if (attendanceRate < 70) {
                recommendations.push({
                    student: student,
                    priority: 'high',
                    title: 'Low Attendance',
                    content: `${student.name} has only ${attendanceRate}% attendance rate. This may indicate issues with engagement or external factors.`
                });
            }
            
            if (lateRate > 30) {
                recommendations.push({
                    student: student,
                    priority: 'medium',
                    title: 'Frequent Late Arrivals',
                    content: `${student.name} is frequently late (${lateRate}% of sessions). Consider discussing punctuality.`
                });
            }
            
            if (daysSinceLastAttendance > 7) {
                recommendations.push({
                    student: student,
                    priority: 'high',
                    title: 'Extended Absence',
                    content: `${student.name} hasn't attended any sessions for ${daysSinceLastAttendance} days. Follow up to check on their wellbeing.`
                });
            }
            
            if (attendanceRate > 90 && lateRate < 10) {
                recommendations.push({
                    student: student,
                    priority: 'low',
                    title: 'Excellent Attendance',
                    content: `${student.name} maintains excellent attendance (${attendanceRate}%) with good punctuality. Consider recognizing their commitment.`
                });
            }
        });
        
        // Sort by priority (high to low)
        const priorityOrder = { 'high': 3, 'medium': 2, 'low': 1 };
        recommendations.sort((a, b) => priorityOrder[b.priority] - priorityOrder[a.priority]);
        
        // Display recommendations
        if (recommendations.length === 0) {
            container.innerHTML = '<p style="text-align: center;">No recommendations at this time. All students are performing well!</p>';
            return;
        }
        
        recommendations.forEach(rec => {
            const card = document.createElement('div');
            card.className = 'recommendation-card';
            
            card.innerHTML = `
                <div class="recommendation-header">
                    <div class="recommendation-title">${rec.title} - ${rec.student.name}</div>
                    <div class="recommendation-priority priority-${rec.priority}">${rec.priority.toUpperCase()}</div>
                </div>
                <div class="recommendation-content">${rec.content}</div>
            `;
            
            container.appendChild(card);
        });
    }

    // Load settings
    function loadSettings() {
        document.getElementById('default-time-limit').value = settings.defaultTimeLimit;
        document.getElementById('late-threshold').value = settings.lateThreshold;
        document.getElementById('time-limit').value = settings.defaultTimeLimit;
        document.getElementById('recognition-threshold').value = settings.recognitionThreshold;
        document.getElementById('threshold-value').textContent = settings.recognitionThreshold;
        document.getElementById('default-recognition-threshold').value = settings.recognitionThreshold;
        document.getElementById('default-threshold-value').textContent = settings.recognitionThreshold;
        document.getElementById('require-liveness').checked = settings.requireLiveness;
        document.getElementById('security-level').value = settings.securityLevel;
        document.getElementById('enable-challenge').checked = settings.enableChallenge;
        document.getElementById('enable-blink-detection').checked = settings.enableBlinkDetection;
        
        updateSecurityScore();
    }

    // Save settings
    function saveSettings() {
        settings = {
            defaultTimeLimit: parseInt(document.getElementById('default-time-limit').value) || 15,
            lateThreshold: parseInt(document.getElementById('late-threshold').value) || 5,
            recognitionThreshold: parseFloat(document.getElementById('default-recognition-threshold').value) || 0.5,
            requireLiveness: document.getElementById('require-liveness').checked,
            securityLevel: document.getElementById('security-level').value,
            enableChallenge: document.getElementById('enable-challenge').checked,
            enableBlinkDetection: document.getElementById('enable-blink-detection').checked
        };
        
        localStorage.setItem('settings', JSON.stringify(settings));
        updateSecurityScore();
        showMessage('Settings saved successfully!', 'success', 'settings-message');
    }

    // Export all data
    function exportAllData() {
        const data = {
            students,
            attendanceRecords,
            attendanceSessions,
            settings,
            exportDate: new Date().toISOString()
        };
        
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `smartface_backup_${new Date().toISOString().split('T')[0]}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showMessage('All data exported successfully!', 'success', 'settings-message');
    }

    // Clear all data
    function clearAllData() {
        if (confirm('Are you sure you want to clear ALL data? This action cannot be undone.')) {
            students = [];
            attendanceRecords = [];
            attendanceSessions = [];
            settings = {
                defaultTimeLimit: 15,
                lateThreshold: 5,
                recognitionThreshold: 0.5,
                requireLiveness: true,
                securityLevel: 'medium',
                enableChallenge: true,
                enableBlinkDetection: true
            };
            
            localStorage.removeItem('students');
            localStorage.removeItem('attendanceRecords');
            localStorage.removeItem('attendanceSessions');
            localStorage.setItem('settings', JSON.stringify(settings));
            
            loadStudentsTable();
            document.querySelector('#report-table tbody').innerHTML = '';
            document.querySelector('#current-attendance tbody').innerHTML = '';
            document.getElementById('sessions-container').innerHTML = '';
            document.getElementById('recommendations-container').innerHTML = '';
            loadSettings();
            updateStats();
            
            // Destroy charts if they exist
            Object.values(charts).forEach(chart => {
                if (chart && typeof chart.destroy === 'function') {
                    chart.destroy();
                }
            });
            charts = {
                attendanceTrend: null,
                attendanceDistribution: null,
                studentPerformance: null,
                dayOfWeek: null
            };
            
            showMessage('All data cleared successfully!', 'success', 'settings-message');
        }
    }

    // Update statistics
    function updateStats() {
        // Total students
        document.getElementById('total-students').textContent = students.length;
        
        // Today's attendance rate (ensure it doesn't exceed 100%)
        const today = new Date().toISOString().split('T')[0];
        const todayRecords = attendanceRecords.filter(record => record.date === today && (record.status === 'Present' || record.status === 'Late'));
        const uniqueStudentsToday = [...new Set(todayRecords.map(record => record.regNumber))];
        const attendanceRate = students.length > 0 ? 
            Math.min(100, Math.round((uniqueStudentsToday.length / students.length) * 100)) : 0;
        
        document.getElementById('today-attendance').textContent = `${attendanceRate}%`;
        
        // Late arrivals count
        const lateCount = todayRecords.filter(record => record.status === 'Late').length;
        document.getElementById('late-arrivals').textContent = lateCount;
        
        // Monthly average (simplified - using last 30 days)
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const recentRecords = attendanceRecords.filter(record => {
            const recordDate = new Date(record.date);
            return recordDate >= thirtyDaysAgo && (record.status === 'Present' || record.status === 'Late');
        });
        const uniqueStudentsRecent = [...new Set(recentRecords.map(record => record.regNumber))];
        const monthlyRate = students.length > 0 ? 
            Math.min(100, Math.round((uniqueStudentsRecent.length / students.length) * 100)) : 0;
        document.getElementById('monthly-average').textContent = `${monthlyRate}%`;
    }

    // Toggle dark mode
    function toggleDarkMode() {
        const isDarkMode = document.getElementById('dark-mode-toggle').checked;
        
        if (isDarkMode) {
            document.body.classList.add('dark-mode');
            localStorage.setItem('darkMode', 'enabled');
        } else {
            document.body.classList.remove('dark-mode');
            localStorage.setItem('darkMode', 'disabled');
        }
    }

    // Open tab
    function openTab(tabName) {
        // Hide all tab contents
        const tabContents = document.getElementsByClassName('tab-content');
        for (let i = 0; i < tabContents.length; i++) {
            tabContents[i].classList.remove('active');
        }
        
        // Remove active class from all tabs
        const tabs = document.getElementsByClassName('tab');
        for (let i = 0; i < tabs.length; i++) {
            tabs[i].classList.remove('active');
        }
        
        // Show the specific tab content
        document.getElementById(tabName).classList.add('active');
        
        // Add active class to the clicked tab
        event.currentTarget.classList.add('active');
        
        // Update sessions dropdown when opening reports tab
        if (tabName === 'report') {
            updateSessionsDropdown();
        }
        
        // Initialize or update charts when opening dashboard
        if (tabName === 'dashboard') {
            // Small delay to ensure the canvas is visible in the DOM
            setTimeout(() => {
                if (!charts.attendanceTrend || typeof charts.attendanceTrend.update === 'undefined') {
                    initializeCharts();
                } else {
                    updateChartsWithData();
                }
            }, 100);
        }
        
        // Load sessions when opening sessions tab
        if (tabName === 'sessions') {
            loadAllSessions();
        }
    }

    // Show message
    function showMessage(message, type, elementId = null) {
        const messageEl = elementId ? 
            document.getElementById(elementId) : 
            document.getElementById('register-message');
            
        messageEl.textContent = message;
        messageEl.className = 'status-message';
        
        if (type === 'success') {
            messageEl.classList.add('success-message');
        } else if (type === 'error') {
            messageEl.classList.add('error-message');
        } else if (type === 'info') {
            messageEl.classList.add('info-message');
        }
        
        messageEl.classList.remove('hidden');
        
        // Auto-hide success messages after 5 seconds
        if (type === 'success') {
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 5000);
        }
    }
</script>
</body>
</html>